# 日志方案

> 适用场景：Spring Boot + Logback + 单体服务 + Datadog + Redis 动态控制日志级别

---

## 一、目标

| 目标 | 说明 |
|------|------|
| 人类可读 | 本地调试、快速排查 |
| 机器可分析 | Datadog 采集、AI 分析 |
| 支持低概率 Bug 抓现场 | 动态开启 DEBUG |
| 动态调节日志级别 | Redis 控制开关 |
| 控制成本 | 避免日志爆炸 |

---

## 二、架构

```
Spring Boot / Logback
        │
        ├── Console（text）
        ├── business.log（text）
        ├── business.json.log（JSON）← Datadog Agent 采集
        └── audit.json.log（JSON）  ← Datadog Agent 采集
                      │
               Datadog Agent
                      │
               Datadog Logs

Redis：动态调 logger level
```

---

## 三、日志分层

### ① 文本日志（Text）

- 输出到控制台 + rolling file
- 用于本地调试、SSH 登录排查

格式示例：
```
2026-02-22 10:32:11 INFO [http-nio-8080] PaymentService - refund success orderId=xxx
```

### ② JSON 日志（核心）

格式：NDJSON（每行一个 JSON）

```json
{
  "timestamp": "2026-02-22T10:32:11.123+09:00",
  "level": "INFO",
  "service": "payment-service",
  "env": "prod",
  "event": "payment.refund",
  "order_id": "123",
  "user_id": "888",
  "request_id": "abc-xyz"
}
```

### ③ 审计日志（Audit）

单独 JSON 文件，记录关键行为：退款、权限变更、配置变更等。

优势：不被业务日志污染，可单独保留更久，可单独设 index。

---

## 四、Redis 动态控制

### 可控范围

| 可控 | 不可控 |
|------|--------|
| DEBUG | ERROR |
| 指定模块日志 | 系统错误日志 |
| 临时抓现场 | 审计日志 |

### 键设计

```
log:level:root = INFO
log:level:com.xxx.payment = DEBUG
log:switch:verbose = 1
```

### 使用规则

- 每 10～30 秒刷新一次
- 本地缓存，不在每次打日志时查询 Redis

---

## 五、Datadog 配置

**只采集 JSON 文件**：

```
logs/*.json.log
```

**必须包含的字段**：

| 字段 | 说明 |
|------|------|
| service | 服务名 |
| env | 环境 |
| version | 版本 |
| request_id | 请求 ID |
| trace_id | 链路 ID（开启 APM 时） |

**成本控制**：

- INFO 适度打印
- DEBUG 默认关闭
- 高噪音日志做采样
- 关键日志单独设 index

---

## 六、最佳实践

### 技术栈

- SLF4J + Logback
- logstash-logback-encoder
- MDC 注入：`request_id` / `user_id` / `order_id`

### event 命名规范

统一使用结构化命名，便于聚合分析：

```
payment.create
payment.refund
device.connect
device.offline
```

### 日志等级

| 等级 | 用途 |
|------|------|
| ERROR | 必须处理的错误 |
| WARN | 潜在风险 |
| INFO | 关键业务流 |
| DEBUG | 临时排查，默认关闭 |
| TRACE | 不建议线上使用 |
